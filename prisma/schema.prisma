// PartyTab data model

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum TabStatus {
  ACTIVE
  CLOSED
}

enum SettlementAcknowledgementStatus {
  PENDING
  ACKNOWLEDGED
}

enum AuthProvider {
  GUEST
  EMAIL
  GOOGLE
}

enum SubscriptionTier {
  GUEST // Not signed up, using PIN only
  BASIC // Free account with Google/Email
  PRO   // Paid account with full features
}

model User {
  id           String       @id @default(uuid()) @db.Uuid
  displayName  String
  email        String?      @unique
  phone        String?

  // Auth fields
  authProvider     AuthProvider     @default(GUEST)
  subscriptionTier SubscriptionTier @default(GUEST)
  googleId         String?          @unique
  passwordHash     String?          // bcrypt hash for email auth
  pinHash          String?          // Hashed 4-digit PIN for guest mode

  // Account linking (for merging guest â†’ authenticated)
  linkedFromId String?      @db.Uuid
  linkedFrom   User?        @relation("AccountLink", fields: [linkedFromId], references: [id])
  linkedTo     User[]       @relation("AccountLink")

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  tabs                         Tab[]                       @relation("TabCreator")
  participants                 Participant[]
  expensesCreated              Expense[]                   @relation("ExpenseCreator")
  invitesCreated               Invite[]                    @relation("InviteCreator")
  acknowledgementsInitiated    SettlementAcknowledgement[] @relation("AckInitiated")
  acknowledgementsAcknowledged SettlementAcknowledgement[] @relation("AckAcknowledged")
  claimTokens                  UserClaimToken[]

  // Pro / Billing
  stripeCustomer      StripeCustomer?
  stripeSubscriptions StripeSubscription[]
  entitlement         Entitlement?
  receiptUsage        ReceiptUsage[]
  receipts            Receipt[]

  // Reminders / Notifications
  createdReminderSettings TabReminderSetting[]
  reminderLogs            TabReminderLog[]
  pushSubscriptions       PushSubscription[]
  emailPreference         EmailPreference?
}

// Claim token for placeholder users (added by others, claimed via link)
model UserClaimToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @db.Uuid
  token     String    @unique
  createdAt DateTime  @default(now())
  claimedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Tab {
  id              String    @id @default(uuid()) @db.Uuid
  name            String
  description     String?
  status          TabStatus @default(ACTIVE)
  startDate       DateTime  @default(now())
  endDate         DateTime?
  createdByUserId String    @db.Uuid
  createdAt       DateTime  @default(now())
  closedAt        DateTime?

  createdBy        User                        @relation("TabCreator", fields: [createdByUserId], references: [id])
  participants     Participant[]
  expenses         Expense[]
  settlement       Settlement?
  invites          Invite[]
  acknowledgements SettlementAcknowledgement[]

  // Pro
  receipts         Receipt[]
  reminderSettings TabReminderSetting?
  reminderLogs     TabReminderLog[]
}

model Participant {
  id       String   @id @default(uuid()) @db.Uuid
  tabId    String   @db.Uuid
  userId   String   @db.Uuid
  joinedAt DateTime @default(now())

  tab              Tab                         @relation(fields: [tabId], references: [id])
  user             User                        @relation(fields: [userId], references: [id])
  expensesPaid     Expense[]                   @relation("ExpensePayer")
  splits           ExpenseSplit[]
  settlementFrom   SettlementTransfer[]        @relation("SettlementFrom")
  settlementTo     SettlementTransfer[]        @relation("SettlementTo")
  acknowledgementsFrom SettlementAcknowledgement[] @relation("AckFrom")
  acknowledgementsTo   SettlementAcknowledgement[] @relation("AckTo")
  itemClaims       ReceiptItemClaim[]

  @@unique([tabId, userId])
}

model Expense {
  id                  String   @id @default(uuid()) @db.Uuid
  tabId               String   @db.Uuid
  paidByParticipantId String   @db.Uuid
  amountTotalCents    Int
  note                String?
  date                DateTime @default(now()) // The date the expense occurred
  createdByUserId     String   @db.Uuid
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Receipt attachment
  receiptUrl String?

  // Receipt parsed totals (for tax/tip/fee distribution)
  receiptSubtotalCents Int?
  receiptTaxCents      Int?
  receiptTipCents      Int?
  receiptTipPercent    Float? // Tip as percentage (e.g., 20.0 for 20%)
  receiptFeeCents      Int?   // Service fees, admin fees, convenience fees, etc.

  tab          Tab            @relation(fields: [tabId], references: [id])
  paidBy       Participant    @relation("ExpensePayer", fields: [paidByParticipantId], references: [id])
  createdBy    User           @relation("ExpenseCreator", fields: [createdByUserId], references: [id])
  splits       ExpenseSplit[]
  receiptItems ReceiptItem[]
}

model ExpenseSplit {
  id            String @id @default(uuid()) @db.Uuid
  expenseId     String @db.Uuid
  participantId String @db.Uuid
  amountCents   Int

  expense     Expense     @relation(fields: [expenseId], references: [id])
  participant Participant @relation(fields: [participantId], references: [id])

  @@unique([expenseId, participantId])
}

// Parsed receipt line items
model ReceiptItem {
  id         String @id @default(uuid()) @db.Uuid
  expenseId  String @db.Uuid
  name       String
  priceCents Int
  quantity   Int    @default(1)
  sortOrder  Int    @default(0)

  expense Expense            @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  claims  ReceiptItemClaim[]
}

// Item claims (who consumed what)
model ReceiptItemClaim {
  id            String @id @default(uuid()) @db.Uuid
  receiptItemId String @db.Uuid
  participantId String @db.Uuid

  receiptItem ReceiptItem @relation(fields: [receiptItemId], references: [id], onDelete: Cascade)
  participant Participant @relation(fields: [participantId], references: [id])

  @@unique([receiptItemId, participantId])
}

model Settlement {
  id        String   @id @default(uuid()) @db.Uuid
  tabId     String   @unique @db.Uuid
  createdAt DateTime @default(now())

  tab       Tab                  @relation(fields: [tabId], references: [id])
  transfers SettlementTransfer[]
}

model SettlementTransfer {
  id                String @id @default(uuid()) @db.Uuid
  settlementId      String @db.Uuid
  fromParticipantId String @db.Uuid
  toParticipantId   String @db.Uuid
  amountCents       Int

  settlement      Settlement  @relation(fields: [settlementId], references: [id])
  fromParticipant Participant @relation("SettlementFrom", fields: [fromParticipantId], references: [id])
  toParticipant   Participant @relation("SettlementTo", fields: [toParticipantId], references: [id])
}

model SettlementAcknowledgement {
  id                   String                        @id @default(uuid()) @db.Uuid
  tabId                String                        @db.Uuid
  fromParticipantId    String                        @db.Uuid
  toParticipantId      String                        @db.Uuid
  amountCents          Int
  status               SettlementAcknowledgementStatus @default(PENDING)
  initiatedByUserId    String                        @db.Uuid
  initiatedAt          DateTime                      @default(now())
  acknowledgedByUserId String?                       @db.Uuid
  acknowledgedAt       DateTime?

  tab             Tab         @relation(fields: [tabId], references: [id])
  fromParticipant Participant @relation("AckFrom", fields: [fromParticipantId], references: [id])
  toParticipant   Participant @relation("AckTo", fields: [toParticipantId], references: [id])
  initiatedBy     User        @relation("AckInitiated", fields: [initiatedByUserId], references: [id])
  acknowledgedBy  User?       @relation("AckAcknowledged", fields: [acknowledgedByUserId], references: [id])

  @@unique([tabId, fromParticipantId, toParticipantId])
}

model Invite {
  id              String    @id @default(uuid()) @db.Uuid
  tabId           String    @db.Uuid
  token           String    @unique
  createdByUserId String    @db.Uuid
  createdAt       DateTime  @default(now())
  revokedAt       DateTime?

  tab       Tab  @relation(fields: [tabId], references: [id])
  createdBy User @relation("InviteCreator", fields: [createdByUserId], references: [id])
}

// --- New Models for PartyTab Pro ---

model StripeCustomer {
  userId           String   @id @db.Uuid @map("user_id")
  stripeCustomerId String   @unique @map("stripe_customer_id")
  createdAt        DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])
  @@map("stripe_customers")
}

model StripeSubscription {
  id                   String   @id @default(uuid()) @db.Uuid
  userId               String   @db.Uuid @map("user_id")
  stripeSubscriptionId String   @unique @map("stripe_subscription_id")
  stripePriceId        String   @map("stripe_price_id")
  stripeStatus         String   @map("stripe_status")
  currentPeriodStart   DateTime @map("current_period_start")
  currentPeriodEnd     DateTime @map("current_period_end")
  cancelAtPeriodEnd    Boolean  @map("cancel_at_period_end")
  updatedAt            DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])
  @@map("stripe_subscriptions")
}

model Entitlement {
  userId      String    @id @db.Uuid @map("user_id")
  plan        String // FREE | PRO
  state       String // FREE | PRO_ACTIVE | PRO_PAST_DUE | PRO_CANCELED
  effectiveAt DateTime  @default(now()) @map("effective_at")
  expiresAt   DateTime? @map("expires_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])
  @@map("entitlements")
}

model StripeEvent {
  eventId    String   @id @unique @map("event_id")
  type       String
  receivedAt DateTime @default(now()) @map("received_at")
  @@map("stripe_events")
}

model ReceiptUsage {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid @map("user_id")
  month     String // YYYY-MM
  count     Int      @default(0)
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])
  @@unique([userId, month])
  @@map("receipt_usage")
}

model Receipt {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @db.Uuid @map("user_id")
  tabId           String   @db.Uuid @map("tab_id")
  imageStorageKey String   @map("image_storage_key")
  parsedItemsJson String   @map("parsed_items_json") // JSON
  taxTotalCents   Int      @map("tax_total_cents")
  tipTotalCents   Int      @map("tip_total_cents")
  feesTotalCents  Int      @map("fees_total_cents")
  allocationJson  String   @map("allocation_json") // JSON
  createdAt       DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])
  tab  Tab  @relation(fields: [tabId], references: [id])
  @@map("receipts")
}

model TabReminderSetting {
  tabId             String   @id @db.Uuid @map("tab_id")
  enabled           Boolean  @default(false)
  enabledAt         DateTime? @map("enabled_at")
  scheduleDaysJson  String   @default("[3,7,14]") @map("schedule_days_json")
  channelPush       Boolean  @default(true) @map("channel_push")
  channelEmail      Boolean  @default(true) @map("channel_email")
  createdByUserId   String   @db.Uuid @map("created_by_user_id")
  updatedAt         DateTime @updatedAt @map("updated_at")

  tab       Tab  @relation(fields: [tabId], references: [id])
  createdBy User @relation(fields: [createdByUserId], references: [id])
  @@map("tab_reminder_settings")
}

model TabReminderLog {
  id              String   @id @default(uuid()) @db.Uuid
  tabId           String   @db.Uuid @map("tab_id")
  recipientUserId String   @db.Uuid @map("recipient_user_id")
  channel         String // push | email
  sentAt          DateTime @default(now()) @map("sent_at")
  status          String // sent | skipped | failed
  reason          String?

  tab           Tab  @relation(fields: [tabId], references: [id])
  recipientUser User @relation(fields: [recipientUserId], references: [id])
  @@map("tab_reminder_log")
}

model PushSubscription {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @db.Uuid @map("user_id")
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id])
  @@map("push_subscriptions")
}

model EmailPreference {
  userId                String    @id @db.Uuid @map("user_id")
  reminderEmailsEnabled Boolean   @default(true) @map("reminder_emails_enabled")
  unsubscribedAt        DateTime? @map("unsubscribed_at")

  user User @relation(fields: [userId], references: [id])
  @@map("email_preferences")
}
